// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  passwordHash   String
  defaultPercent Int      @default(10)
  locale         String   @default("he")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  fixedCharities    FixedCharity[]
  incomes           Income[]
  paymentSnapshots  PaymentSnapshot[]
  sharedWith        SharedAccess[] @relation("owner")
  sharedFrom        SharedAccess[] @relation("viewer")
}

model FixedCharity {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  amount    Int      // in agorot/cents for precision
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Income {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month       String   // "2024-01" for queries
  amount      Int      // gross income (agorot)
  percentage  Int      // user's % at time of entry
  maaser      Int      // calculated: amount Ã— %
  description String?
  isFrozen    Boolean  @default(false) // frozen incomes cannot be edited/deleted
  createdAt   DateTime @default(now())

  @@index([userId, month])
}

model PaymentSnapshot {
  id                     String   @id @default(cuid())
  userId                 String
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  month                  String   // "2024-12" format

  // When payment was made
  paidAt                 DateTime @default(now())

  // Financial state at time of payment
  totalMaaser            Int      // Total maaser at this moment
  fixedCharitiesTotal    Int      // Fixed charities deducted (0 if not first)
  amountPaid             Int      // Amount user paid in THIS event

  // Snapshots for audit trail
  incomeSnapshot         Json     // Array of {id, amount, percentage, maaser}
  fixedCharitiesSnapshot Json     // Array of {name, amount}

  createdAt              DateTime @default(now())

  @@index([userId, month])
  @@index([userId, paidAt])
}

model SharedAccess {
  id         String   @id @default(cuid())
  ownerId    String
  owner      User     @relation("owner", fields: [ownerId], references: [id], onDelete: Cascade)
  viewerId   String
  viewer     User     @relation("viewer", fields: [viewerId], references: [id], onDelete: Cascade)
  canEdit    Boolean  @default(false)
  isSelected Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@unique([ownerId, viewerId])
  @@index([ownerId])
  @@index([viewerId])
}
